name: adottaungatto-it

services:
  postgres:
    image: postgis/postgis:16-3.4
    container_name: adottaungatto-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-adottaungatto}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-adottaungatto}
      POSTGRES_DB: ${POSTGRES_DB:-adottaungatto}
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-adottaungatto} -d ${POSTGRES_DB:-adottaungatto}']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  redis:
    image: redis:7.4-alpine
    container_name: adottaungatto-redis
    command: ['redis-server', '--appendonly', 'yes']
    ports:
      - '${REDIS_PORT:-6379}:6379'
    volumes:
      - redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s

  opensearch:
    image: opensearchproject/opensearch:2.19.1
    container_name: adottaungatto-opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - '${OPENSEARCH_PORT:-9200}:9200'
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    healthcheck:
      test: ['CMD-SHELL', 'curl -fsS http://localhost:9200/_cluster/health || exit 1']
      interval: 15s
      timeout: 10s
      retries: 15
      start_period: 30s

  minio:
    image: minio/minio:latest
    container_name: adottaungatto-minio
    command: server /data --console-address ':9001'
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    ports:
      - '${MINIO_API_PORT:-9000}:9000'
      - '${MINIO_CONSOLE_PORT:-9001}:9001'
    volumes:
      - minio-data:/data
    healthcheck:
      test: ['CMD-SHELL', 'curl -fsS http://localhost:9000/minio/health/live || exit 1']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  keycloak:
    image: quay.io/keycloak/keycloak:26.1
    container_name: adottaungatto-keycloak
    command: start-dev --http-port=8080
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_HEALTH_ENABLED: 'true'
      KC_METRICS_ENABLED: 'true'
      KC_HOSTNAME_STRICT: 'false'
    ports:
      - '${KEYCLOAK_PORT:-8080}:8080'
    volumes:
      - keycloak-data:/opt/keycloak/data
    healthcheck:
      test:
        [
          'CMD-SHELL',
          "bash -lc \"exec 3<>/dev/tcp/127.0.0.1/9000 && printf 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && grep -q '200' <&3\"",
        ]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 30s

  mailpit:
    image: axllent/mailpit:v1.24
    container_name: adottaungatto-mailpit
    ports:
      - '${MAILPIT_SMTP_PORT:-1025}:1025'
      - '${MAILPIT_UI_PORT:-8025}:8025'
    volumes:
      - mailpit-data:/data
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://localhost:8025/api/v1/info || exit 1']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s

volumes:
  postgres-data:
  redis-data:
  opensearch-data:
  minio-data:
  keycloak-data:
  mailpit-data:
